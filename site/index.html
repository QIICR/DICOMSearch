<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="shortcut icon" type="image/ico" href="http://couchdb.apache.org/favicon.ico">

	<title>A Searchable Version of the DICOM Standard</title>

  <script src="./js/json2.js"></script>
  <script src="./js/sha1.js"></script>
  <script src="./js/jquery.js"></script>
  <script src="./js/jquery.couch.js"></script>
  <script src="./js/jquery.dialog.js"></script>
  <script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

  <link href="./css/dicom.css" rel="stylesheet" type="text/css" />
  <link href="./css/dicom.search.css" rel="stylesheet" type="text/css" />

  <script>
  // open the corresponding part of the standard on search result click
  var linkHandler = function(link){
    partFile = link.innerHTML.split(',')[0]
    $('#dicomText').load('./html/'+partFile+'.html');
  }


$(function() {

  var getURLParameter = function(parameter) {
      // from http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
      var pageURL = window.location.search.substring(1);
      var urlVariables = pageURL.split('&');
      for (var i = 0; i < urlVariables.length; i++) {
          var parameterName = urlVariables[i].split('=');
          if (parameterName[0] == parameter) {
              return parameterName[1];
          }
      }
  };

  var hitCountRequest, hitRequest;

  // clear the search results and issue an ajax query
  // to the database.  Populate the result are with
  // results of query.
  var updateHits = function(key) {

    // clear previous results
    $('#hitList p').remove();
    $('#resultTable h3').remove();
    $('#resultTable p').remove();

    // abort pending requests
    if (hitCountRequest) { hitCountRequest.abort(); }
    if (hitRequest) { hitRequest.abort(); }

    if (key.length <= 4) { return; }
    key = key.toLocaleLowerCase();

    var limit = 10; // TODO: better version of this block
    if ($('#limit20').attr('checked')) { limit = 20; }
    if ($('#limit100').attr('checked')) { limit = 100; }
    if ($('#limitAll').attr('checked')) { limit = 99999999; } // needs to be an int

    // update the hit list
    hitCountRequest = $.couch.db("dicom_search").view("search/paraByWord", {
      success: function(data) {
        // add a row with the current word count
        var hits = 0;
        if (data.rows.length > 0) {
          hits = data.rows[0].value;
        }
        $('#hitList')
          .append($("<p class='hitcount'>" + key + " (" + hits + " hits)<p>"));
      },
      error: function(status) {
        console.log("Error: " + status);
      },
      key : key,
      reduce : true,
    });

    // update the result table
    hitRequest = $.couch.db("dicom_search").view("search/paraByWord", {
      success: function(data) {
        // add entries for each hit
        $.each(data.rows, function(index,value) {
          $('#resultTable')
            .append($("<p class='citation'>" + value.doc._id + "</p>"))
            .append($("<a href='#' onclick=\"linkHandler(this);return false;\">"+value.doc._id+"</a></p>"))
            .append($("<p class='paragraph'>" + value.doc.text + "</p>"));
        });
        // hightlight the search term
        $('.paragraph').html( function(index,currentContent) {
          return(currentContent.replace( key, "<span class='highlight'>" + key + "</span>"));
        });
      },
      error: function(status) {
        console.log(status);
      },
      startkey : key,
      endkey : key,
      limit : limit,
      reduce : false,
      include_docs : true
    });
  };

  // make the limit input into a jqui spinner
  $('#limit').buttonset();

  // update result on key press
  $('#searchWord').keyup(function(e) {
    updateHits($(this).val());
  });
  $('#limit input').click(function(e) {
    updateHits($('#searchWord').val());
  });

  // set up initial search
  var searchWord = 'DICOM';
  var passedSearchWord = getURLParameter('search');
  if (passedSearchWord) {
    searchWord = passedSearchWord;
  }
  $('#searchWord').val(searchWord);
  updateHits(searchWord);
  $('#searchWord').focus();
});

	</script>
</head>

<body>
	<div class="header">
			<h1>A Searchable Version of the DICOM Standard</h1>
  </div>

  <div class="main">
    <div class="leftTop">
      <div id="searchBox" class="inputArea">

        <label for="limit">Results per query</label>
        <div id="limit">
          <input type="radio" id="limit10" name="limit" checked="checked"><label for="limit10">10</label>
          <input type="radio" id="limit20" name="limit"><label for="limit20">20</label>
          <input type="radio" id="limit100" name="limit"><label for="limit100">100</label>
          <input type="radio" id="limitAll" name="limit"><label for="limitAll">All</label>
        </div>

        <label for="search">Word to search for: </label>
        <input id="searchWord">
      </div>
      <div id="hitList" class="hitList">
      </div>
    </div>

    <div class="leftBottom">

      <div id="resultTable" class="results">
      </div>
    </div>

    <div class="right">

      <div id="dicomText" class="results">
      </div>
    </div>

  <div class="footer">
    <p class="copyright">
    This interface provided by <a href="http://qiicr.org">QIICR</a> &#169; 2014.<nbsp><nbsp><nbsp><nbsp>
    The DICOM Standard is &#169; <a href="http://dicom.nema.org">NEMA</a> 2014.<br>
    </p>
    <p>
    Related projects include:
    <a href="http://slicer.org">3D Slicer</a>
    <a href="http://na-mic.org">NA-MIC</a>
    <a href="http://nac.spl.harvard.edu">NAC</a>
    <a href="http://ncigt.org">NCIGT</a>
    <a href="http://commontk.org">CTK</a>
    </p>
  </div>
</div>
</body>
</html>

